name: Deploy to production server
on:
  push:
    branches:
      - master

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Start Notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.MN_TG_CHAT_ID }}
          token: ${{ secrets.TG_BOT_TOKEN }}
          format: markdown
          message: |
            *‚ôªÔ∏è –î–µ–ø–ª–æ–π –∑–∞–ø—É—â–µ–Ω*
            *üåç –°–µ—Ä–≤–µ—Ä:* –ú–µ—á—Ç–∞
            *üì± –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:* ¬´jQuery Todo¬ª
            *üõ†Ô∏è –¢–∏–ø:* Frontend

      - name: Git clone repository
        uses: actions/checkout@v4

      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js 20.x (LTS)
      - name: Setup Node.js
        uses: actions/checkout@v4
        with:
          node-version: 'lts/iron'
          cache: 'pnpm'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies with Pnpm
        run: pnpm install

      - name: Compile TypeScript
        run: pnpm build

      - name: Create BZIP deployment package
        run: tar -cjf build-front.tar.bz2 dist/*

      - name: Copy file to serve
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          source: build-front.tar.bz2
          target: ~/uploads/

      - name: Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd /var/www/${{ secrets.FRONTEND_FOLDER}}
            rm -rf *
            tar -C ./ -xjf ~/uploads/build-front.tar.bz2 --strip-components 1
            rm -rf ~/uploads/build-front.tar.bz2

      - name: Success Notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.MN_TG_CHAT_ID }}
          token: ${{ secrets.TG_BOT_TOKEN }}
          format: markdown
          message: |
            *‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω*
            *üåç –°–µ—Ä–≤–µ—Ä:* –ú–µ—á—Ç–∞
            *üì± –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:* ¬´jQuery Todo¬ª
            *üõ†Ô∏è –¢–∏–ø:* Frontend
            ||–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞: ${{ github.event.commits[0].message }}||

      - name: Failed Notification
        if: ${{ failure() }}
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.MN_TG_CHAT_ID }}
          token: ${{ secrets.TG_BOT_TOKEN }}
          format: markdown
          message: |
            *‚ùå –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω –Ω–µ—É–¥–∞—á–µ–π*
            *üåç –°–µ—Ä–≤–µ—Ä:* –ú–µ—á—Ç–∞
            *üì± –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:* ¬´jQuery Todo¬ª
            *üõ†Ô∏è –¢–∏–ø:* Frontend
            ||–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞: ${{ github.event.commits[0].message }}||


