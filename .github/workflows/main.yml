name: Deploy to production server
on:
  push:
    branches:
      - master

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Start Notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.MN_TG_CHAT_ID }}
          token: ${{ secrets.TG_BOT_TOKEN }}
          message: |
            === üé® Frontend ===
            ‚ôªÔ∏è –°–µ–π—á–∞—Å –±—É–¥—É—Ç –≤—ã–∫–∞—á–µ–Ω—ã –Ω–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            (–ø—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è 4 –º–∏–Ω—É—Ç—ã)
            —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –Ω–∞–ª–∏—Ç—å —á–∞–π–∫–∞ ‚òïÔ∏è
            –∏ –¥–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–ø–ª–æ—è üòÄ

      - name: Git clone repository
        uses: actions/checkout@v2

      - name: Node install
        uses: actions/setup-node@v2
        with:
          node-version: 'lts/iron'

      - name: Install dependencies with Yarn
        run: yarn install

      - name: Compile TypeScript
        run: yarn build

      - name: Create BZIP deployment package
        run: tar -cjf build-front.tar.bz2 dist/*

      - name: Copy file to serve
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          source: build-front.tar.bz2
          target: ~/uploads/

      - name: Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd /var/www/renderlife/frontend/
            rm -rf *
            tar -C ./ -xjf ~/uploads/build-front.tar.bz2 --strip-components 1
            rm -rf ~/uploads/build-front.tar.bz2

      - name: Success Notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.MN_TG_CHAT_ID }}
          token: ${{ secrets.TG_BOT_TOKEN }}
          message: |
            üéâ –î–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ¬´jQuery Todo - üé® Frontend
            –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ú–µ—á—Ç—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω.
            –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞: ${{ github.event.commits[0].message }}

      - name: Failed Notification
        if: ${{ failure() }}
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.MN_TG_CHAT_ID }}
          token: ${{ secrets.TG_BOT_TOKEN }}
          message: |
            üî• –î–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ¬´jQuery Todo - üé® Frontend
            –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ú–µ—á—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω –Ω–µ—É–¥–∞—á–µ–π.
            –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞: ${{ github.event.commits[0].message }}

